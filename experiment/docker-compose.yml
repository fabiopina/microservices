version: "2.2"
services:
  main_app:
    image: jaimelive/main_app
    cpus: 0.5
    cpu_percent: 25
    mem_limit: 100m
    expose:
      - "8080"
    links:
      - users_ms_lb
    depends_on:
      - users_ms_lb
    environment:
      - USERSADDRESS=users_ms_lb:80
      - ZIPKINADDRESS=zipkin:9411
  main_app_lb:
    image: dockercloud/haproxy
    depends_on:
      - main_app
    links:
      - main_app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:80"
  users_ms:
    image: jaimelive/users_ms
    cpus: 0.5
    cpu_percent: 25
    mem_limit: 100m
    expose:
      - "5000"
    links:
      - ms_db
    depends_on:
      - ms_db
    environment:
      - DATABASEADDRESS=ms_db:3306
      - ZIPKINADDRESS=zipkin:9411
  users_ms_lb:
    image: dockercloud/haproxy
    depends_on:
      - users_ms
    links:
      - users_ms
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  ms_db:
    image: mariadb
    expose:
      - "3306"
    environment:
      - MYSQL_ROOT_PASSWORD=ribeiro
  storage:
    image: openzipkin/zipkin-elasticsearch
    expose:
      - "9200"
    # volumes_from:
    #   - container:esdata
  # Switch storage type to Elasticsearch
  zipkin:
    image: openzipkin/zipkin
    expose:
      - "9411"
    ports:
      - "8090:9411"
    links:
      - storage
    depends_on:
      - storage
    environment:
      - STORAGE_TYPE=elasticsearch
      - ES_HOSTS=http://storage:9200




